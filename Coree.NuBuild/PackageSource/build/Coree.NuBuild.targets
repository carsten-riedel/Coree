<Project>

  <Target Name="CopyDefaultsFromNuBuild" BeforeTargets="BeforeBuild">
    <CreateItem Include="$(MSBuildThisFileDirectory)..\defaults\*">
      <Output ItemName="ItemsThatNeedToBeCopied" TaskParameter="Include"/>
    </CreateItem>
    <Copy SourceFiles="@(ItemsThatNeedToBeCopied)" DestinationFolder="$(MSBuildProjectDirectory)\Coree.NuBuild.Defaults" Condition="!Exists('$(MSBuildProjectDirectory)\Coree.NuBuild.Defaults\%(ItemsThatNeedToBeCopied.Filename)%(ItemsThatNeedToBeCopied.Extension)')" />
  </Target>

  <Import Project="$(MSBuildProjectDirectory)\Coree.NuBuild.Defaults\Coree.NuBuild.props"  Condition="Exists('$(MSBuildProjectDirectory)\Coree.NuBuild.Defaults\Coree.NuBuild.props')"/>
   
  <Target Name="NuBuildPackTarget" AfterTargets="PostBuildEvent" Condition="'$(NuBuildPropsRun)'=='true'">
    <Message Text="Custom Pack command .." Importance="high" />
    <Message Text="ProjectName: $(ProjectName)" Importance="high" />
    <Exec Command="dotnet pack -p:PackageVersion=$(VersionPrefix)$(VersionMinus)$(VersionSuffix) --no-build --configuration $(Configuration) --output &quot;$(MSBuildProjectDirectory)\Coree.NuBuild.Output&quot;" />
  </Target>
  
   <Target Name="NuBuildPackCopyTarget" AfterTargets="Pack" Condition="'$(NuBuildPropsRun)'=='true' AND '$(NuBuildCopyFileShare)'!=''">
    <Copy SourceFiles="$(MSBuildProjectDirectory)\Coree.NuBuild.Output\$(PackageId).$(PackageVersion).nupkg" DestinationFolder="$(NuBuildCopyFileShare)" />
  </Target>


  <Target Name="NuBuildPushTarget" AfterTargets="Pack" Condition="'$(NuBuildPropsRun)'=='true' AND Exists('$(MSBuildProjectDirectory)\Coree.NuBuild.Defaults\NugetApi.Key')">
    <PropertyGroup>
      <NugetApiValue>$([System.IO.File]::ReadAllText("$(MSBuildProjectDirectory)\Coree.NuBuild.Defaults\NugetApi.Key"))</NugetApiValue>
      <NugetApiValue>$(NugetApiValue.Trim())</NugetApiValue>
    </PropertyGroup>
    <Exec Command="dotnet nuget push &quot;$(MSBuildProjectDirectory)\Coree.NuBuild.Output\$(PackageId).$(PackageVersion).nupkg&quot; -k $(NugetApiValue) -s https://api.nuget.org/v3/index.json"  Condition="'$(NugetApiValue)'!=''" />
  </Target>

</Project>